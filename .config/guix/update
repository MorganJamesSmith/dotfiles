#!/bin/sh

# exit on error
set -e

# Update local Emacs source
cd /home/pancake/src/emacs/emacs
git stash
git rebase --no-gpg-sign

# Update local org-mode source
cd /home/pancake/src/emacs/org-mode
git stash
git rebase --no-gpg-sign

# Update local emms source
cd /home/pancake/src/emacs/emms
git stash
git rebase --no-gpg-sign

guix pull

# don't stop on error
set +e

# dev environment
rm /home/pancake/.config/guix/dev
guix shell --pure -D guix -D emacs-next-pgtk --root=/home/pancake/.config/guix/dev -- echo "done"

# build manifest
guix build --keep-going -m /home/pancake/.config/guix/default-manifest.scm
guix build --keep-going -m /home/pancake/.config/guix/emacs-manifest.scm

# build system
guix system build --keep-going /home/pancake/.config/guix/config.scm

# build home
guix home build --keep-going /home/pancake/.config/guix/home.scm

# Display news
guix pull --news
